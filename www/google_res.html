<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns= "http://www.w3c.org/1999/xhtml">
<head>
<title>google oauth</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Type" content="text/css">
<meta name="viewport" content="width=device-width">
<link href="js/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" charset="utf-8" src="js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/bootstrap/js/bootstrap.min.js"></script>
<script src="./amazon-cognito-identity-js/dist/aws-cognito-sdk.min.js"></script>
<script src="./amazon-cognito-identity-js/dist/amazon-cognito-identity.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.38.0.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/secret.js"></script>
<script src="./js/bundle.js"></script>
<script>
  AWS.config.region = 'us-east-1'; // Region
  AWSCognito.config.region = 'us-east-1';
  
  var poolData = {
    UserPoolId : cognito_user_pool_id, // your user pool id here
    ClientId : congito_client_id // your app client id here
  };
  var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
  var cognitoSignupUser;
  var cognitoLoginUser = null;


$(document).ready(function(){
    let id_token = receiveGoogleImplictOauth();

    $("#awsLoginBtn").on("click", function(){
        //awsLogin(id_token);
        cognitoLogin(id_token);
	});
    
});

function receiveGoogleImplictOauth(){
    var parsedUrl = new URL(window.location.href);
    console.log(parsedUrl.hash);

    let inputData = parseFragments(parsedUrl);
    console.log(inputData);

    $("#access_token").html(inputData.access_token);
    $("#id_token").html(inputData.id_token);

    console.log(parseJwt(inputData.id_token));
    id_token = inputData.id_token;
    return id_token;
}

function cognitoLogin(id_token) {
     // Add the Google access token to the Cognito credentials login map.
     console.log(aws_identity_pool_id);

     AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: aws_identity_pool_id,
        Logins: {
           'accounts.google.com': id_token
        }
     }, {
         region: 'us-east-1'
     });
    //AWS.config.credentials.clearCachedId();
    // Obtain AWS credentials
    AWS.config.credentials.get(function(err){
        // Access AWS resources here.
        //alert("login success");
        console.log(err);
        console.log(AWS.config.credentials);

        showCredentials(AWS.config.credentials.data);
        sendToAPIGateway(AWS.config.credentials.data);
    });
}

function awsLogin(id_token) {


    var params = {
        IdentityPoolId: aws_identity_pool_id, /* required */
        AccountId: aws_account_id,
        //CustomRoleArn: 'STRING_VALUE',
        Logins: {
            'accounts.google.com': id_token
            /* '<IdentityProviderName>': ... */
        }
    };

    var cognitoidentity = new AWS.CognitoIdentity();
    //create identity
    console.log("==getID==");
    cognitoidentity.getId(params, function(err, data) {
        console.log("==getID done==");
        if (err){
            console.log(err, err.stack); // an error occurred
            return;
        }
        $("#identity_id").html(data.IdentityId);
        
        //aws login
        var params2 = {
            IdentityId: data.IdentityId, /* required */
            //CustomRoleArn: 'STRING_VALUE',
            Logins: {
                'accounts.google.com': id_token
                /* '<IdentityProviderName>': ... */
            }
        };

        console.log("==getCredentialsForIdentity==");
        cognitoidentity.getCredentialsForIdentity(params2, function(err, data) {
            console.log("==getCredentialsForIdentity done==");
            if (err) {
                console.log(err, err.stack); // an error occurred
            }
            else {
                console.log(data);
                showCredentials(data);
                sendToAPIGateway(data);
            } 
        });
    });


}


function showCredentials(data){
    let result = "";

    for(let key in data.Credentials){
        result += "<div>"+key+"="+data.Credentials[key]+"</div>";
    }
    $("#aws_credential_div").html(result);
    $("#identity_id").html(data.IdentityId);
}

//utils
function parseFragments(parsedUrl){
    let fragments = parsedUrl.hash.split('&');
    let result = {};

    for(let i in fragments){
        let keyIndex = fragments[i].indexOf('=');
        let key = fragments[i].substring(0, keyIndex);
        let value = fragments[i].substring(keyIndex+1);

        result[key] = value;
    }

    return result;
}

function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace('-', '+').replace('_', '/');
    return JSON.parse(window.atob(base64));
};

</script>
<style>
body {
	padding-top:20px;
}

button{
	height:50px;
	width: 200px;
	margin-top:10px;
	margin-bottom: 10px;
}


</style>
</head>
<body class="container">

<span>Access Token=</span>
<div id="access_token"></div>
<span>ID Token=</span>
<div id="id_token"></div>

<div id="aws_login_div">
  <button class="btn btn-default" id="awsLoginBtn">AWS Login</button>
  <div>Identity ID=<span id="identity_id"></span><div>
</div>
<hr>

<div id="aws_credential_div">
</div>

<hr>

<div id="rest_result">
</div>

</body>
